<!DOCTYPE html>
<html>
<head>
	<title>Caving</title>
	<meta charset="UTF-8">
	<style type="text/css">
		#canvas
		{
			border:solid 2px maroon;
		}
		body
		{
			background-color:black;
		}
		.holder
		{
			padding-top:50px;
			text-align:center;
		}
		.controls{
			margin-bottom: 5px;
		}
		.controls input,.controls button{
			border:solid 1px gray;
			font-family: monospace;
			vertical-align: -5px;
		}
		.controls input{
			width: 3em;
		}
		#gold {
			color:yellow;
		}
		#moves {
			color:red;
		}
		#rocks {
			color:gray;
		}
	</style>
</head>
<body>
	<div class='holder'>
		<div class="controls"><input type="text" id="chance" value="0.92"/> <button id="do">Generate</button></div>
		<canvas id="canvas" width="300" height="300" style="">Your browser doesn't support HTML5 Canvas.</canvas>
		<div class="info"><span id="gold">0</span><span id="rocks">0</span><span id="moves">0</span></div>
	</div>
    <script type="text/javascript" src="NoiseMachine.js"></script>
    <script type="text/javascript">    

      var sampler = new Sampler(44100,0.05);
      var gold_noise = new Channel(sampler.interval,sampler.sampleRate,[sampler.high_a,sampler.g,sampler.c,sampler.a]);
      var dig_noise = new Channel(sampler.interval,sampler.sampleRate,[sampler.noise]);

  	</script>
  	<script type="text/javascript"> 

		var Score = {
			gold:0,
			moves:0,
			rocks:0,
			addOneGold:function(){
				this.gold+=1;
				gold_noise.start();
				document.getElementById("gold").innerHTML=this.gold*10;
			},
			addOneMove:function(){
				this.moves+=1;
				document.getElementById("moves").innerHTML=this.moves;
			},
			addOneRocks:function(){
				this.rocks+=1;
				dig_noise.start();
				document.getElementById("rocks").innerHTML=this.rocks;
			},
			takeOneRocks:function(){
				this.rocks-=1;
				dig_noise.start();
				document.getElementById("rocks").innerHTML=this.rocks;
			}
		};

  	</script>
	<script>
		(function(){

			var Cell = function(canvas_id){
				var me = this;
				var canvas = document.getElementById(canvas_id);
				me.ctx = canvas.getContext('2d');
				me.universe=null;
				me.w=60;
				me.h=60;
				me.cln = null;
				me.black = 'rgb(0,0,0)';
				me.white = 'rgb(255,255,255)';
				me.red = 'rgb(255,0,0)';
				me.green = 'rgb(0,255,0)';
				me.blue = 'rgb(0,0,255)';
				me.purple = 'rgb(255,0,255)';
				me.yellow= 'rgb(240,240,0)';
				me.gray = 'rgb(100,100,100)';
				me.hard = 'rgb(50,50,50)';
				me.hidden = 'rgb(15,10,10)';
				me.stone = 'rgb(80,80,80)'
			};
		
			Cell.prototype.choose = function(a,b,limit){
				return (Math.random()< limit ? a : b);
			};

			Cell.prototype.generate = function(){
				var f = this;
				var v = document.getElementById('chance').value;
				f.universe=[];
				for(var i = 0; i < f.w; i++) {
					f.universe[i] = [];
					for(var j = 0; j < f.h; j++) {
						f.universe[i][j] = f.choose(0,1,v);
					}
				}
			};
			
			Cell.prototype.insideView = function(x,y,ax,ay){
				var distance = 10;
				var sq= function(x){return x*x;};
				if(!x && !y) return true;
				var measured = Math.sqrt(sq(ay-y)+sq(ax-x));
				return measured<distance;
			};

			Cell.prototype.draw = function(){
				var me = this;
				if(me.ctx){
					var wh=5;
					for(var i = 0; i < me.w; i++) {
						for(var j = 0; j < me.h; j++) {
							if(me.insideView(me.x,me.y,j,i)){
								if(me.universe[j][i]===2){
									me.ctx.fillStyle = me.gray;
								} else if(me.universe[j][i]===3){
									me.ctx.fillStyle = me.blue;
								} else if(me.universe[j][i]===4){
									me.ctx.fillStyle = me.red;
								} else if(me.universe[j][i]===5){
									me.ctx.fillStyle = me.green;
								} else if(me.universe[j][i]===6){
									me.ctx.fillStyle = me.purple;
								} else if(me.universe[j][i]===7){
									me.ctx.fillStyle = me.yellow
								} else if(me.universe[j][i]===8){
									me.ctx.fillStyle = me.hard;
								} else {
									me.ctx.fillStyle = me.universe[j][i]?me.white:me.stone;
								}
							} else {
								me.ctx.fillStyle = me.hidden;
							}
							me.ctx.fillRect(wh*j, wh*i, wh*j+wh, wh*i+wh);
						}
					}
				}
			};

			Cell.prototype.drop = function(x,y,v){
				try{
					if(v!==this.cln[x][y]){
						this.universe[x][y]=v;
						return true;
					}
					return false;
				} catch(e) {
					return false;
					console.log('exception:',e);
					console.log(x,y);
				}
			};

			Cell.prototype.getAdjascent = function(x,y,f){
				var n,s,e,w,ne,se,nw,sw = null;
				if(y-1>=0) n = f.cln[x][y-1];
				if(y+1<f.h) s = f.cln[x][y+1];
				if(x+1<f.w) e = f.cln[x+1][y];
				if(x-1>=0) w = f.cln[x-1][y];
				
				if(x+1<f.w && y-1>=0) ne =f.cln[x+1][y-1];
				if(x+1<f.w && y+1<f.h) se =f.cln[x+1][y+1];
				if(x-1>=0 && y-1>=0) nw =f.cln[x-1][y-1];
				if(x-1>=0 && y+1<f.h) sw =f.cln[x-1][y+1];	

				return {
					n: n,
					s: s,
					e: e,
					w: w,
					ne:ne,
					se:se,
					nw:nw,
					sw:sw,
				};
			};

//processes

			Cell.prototype.cave = function(val,x,y){
				var f = this;
				var adj = f.getAdjascent(x,y,f);
				if(val){
					if(adj.n+adj.s+adj.e+adj.w===0){f.drop(x,y,0);}
				} else {
					if(adj.n+adj.s+adj.e+adj.w===4){f.drop(x,y,1);}
					else if(adj.n||adj.s||adj.e||adj.w){
						f.drop(x,y,f.choose(0,1,0.97));
					}
				}
			};

			Cell.prototype.smooth = function(val,x,y){
				var f = this;
				var adj = f.getAdjascent(x,y,f);
				if(val){
					if(adj.n+adj.ne+adj.e+adj.se+adj.s===0){f.drop(x,y,0);}
					if(adj.n+adj.nw+adj.w+adj.sw+adj.s===0){f.drop(x,y,0);}
					if(adj.w+adj.nw+adj.n+adj.ne+adj.e===0){f.drop(x,y,0);}
					if(adj.w+adj.sw+adj.s+adj.se+adj.e===0){f.drop(x,y,0);}
				} else {
					if(adj.n+adj.ne+adj.e+adj.se+adj.s===5){f.drop(x,y,1);}
					if(adj.n+adj.nw+adj.w+adj.sw+adj.s===5){f.drop(x,y,1);}
					if(adj.w+adj.nw+adj.n+adj.ne+adj.e===5){f.drop(x,y,1);}
					if(adj.w+adj.sw+adj.s+adj.se+adj.e===5){f.drop(x,y,1);}
				}
			};

			Cell.prototype.squash = function(val,x,y){
				var f = this;
				var adj = f.getAdjascent(x,y,f);
				if(val){
					if(adj.n+adj.s+adj.e+adj.w===0){f.drop(x,y,0);}
					if(adj.n===null||adj.s===null||adj.e===null||adj.w===null){f.drop(x,y,0);}
				} else {
					if(adj.n+adj.s+adj.e+adj.w===4){f.drop(x,y,1);}
				}
			};

			Cell.prototype.trace = function(val,x,y){
				var f = this;
				var adj = f.getAdjascent(x,y,f);
				if(val){
					if(adj.n!==0&&!adj.n)f.drop(x,y,8);
					if(adj.s!==0&&!adj.s)f.drop(x,y,8);
					if(adj.e!==0&&!adj.e)f.drop(x,y,8);
					if(adj.w!==0&&!adj.w)f.drop(x,y,8);
					if(val!=7){
						if((adj.n===2||adj.n===0)&&
							(adj.s===2||adj.s===0)&&
							(adj.e===2||adj.e===0)&&
							(adj.w===2||adj.w===0))f.drop(x,y,0);
					}
				} else {
					if(val!=7){
						if(adj.n===1||adj.s===1||adj.e===1||adj.w===1)f.drop(x,y,2);
					}
				}
			};

			Cell.prototype.seedWater = function(val,x,y){
				var f = this;
				if(val===1)f.drop(x,y,f.choose(val,3,0.997));
			};

			Cell.prototype.seedGold = function(val,x,y){
				var f = this;
				if(val===0)f.drop(x,y,f.choose(val,7,0.99));
			};

			Cell.prototype.waterFlow = function(val,x,y){
				var f = this;
				var adj = f.getAdjascent(x,y,f);
				if(val===1){
					if(adj.n===3||adj.s===3||adj.e===3||adj.w===3)f.drop(x,y,f.choose(val,3,0.8));
				}
			};

			Cell.prototype.waterFill = function(val,x,y){
				var f = this;
				var n,s,e,w = null;
				var adj = f.getAdjascent(x,y,f);
				if(adj.n===3&&adj.s===3&&adj.e===3&&adj.w===3)f.drop(x,y,3);
				if(adj.n===3&&adj.s===3&&adj.e===3)f.drop(x,y,3);
				if(adj.n===3&&adj.s===3&&adj.w===3)f.drop(x,y,3);
				if(adj.n===3&&adj.e===3&&adj.w===3)f.drop(x,y,3);
				if(adj.s===3&&adj.e===3&&adj.w===3)f.drop(x,y,3);
			};

			Cell.prototype.addStart = function(val,x,y){
				var f = this;
				if(!f.startAdded){
					if(val===1){
						var choice = f.choose(1,4,0.999);
						if(f.drop(x,y,choice) && choice===4){
							f.startAdded=true;
							f.x = x;
							f.y = y;
							f.draw();
						}
					}
				}
			};

//end processes

			Cell.prototype.process = function(val,x,y){
				this.current(val,x,y);
			};
			
			Cell.prototype.clone = function(){
				var me = this;
				var cln = [];
				var i,l = null;
    			for(i = 0; i< me.w; i++) {
					cln[i] = me.universe[i].slice(0);
				}
				return cln;
			};

			Cell.prototype.step = function(){
				var f = this;
				var x,y,val = null;
				f.cln = f.clone();
				for(x = 0; x < f.w; x++) {
					for(y = 0; y < f.h; y++) {
						val = f.cln[x][y];
						f.process(val,x,y);
					}
				}
			};
			
			Cell.prototype.initialise = function(){
				var me = this;
				me.generate();
				me.draw();
				me.startAdded = false;
			};
			
			Cell.prototype.iterate = function(f){
				f.step();
				f.draw();
			};

			Cell.prototype.dig = function(x,y){
				var f = this;
				if(f.universe[x][y]===7){
					Score.addOneGold();
					f.drop(x,y,1);
				} else if (f.universe[x][y]===2){
					f.drop(x,y,1);
					Score.addOneRocks();
				} else if (f.universe[x][y]===1 && Score.rocks>0){
					f.drop(x,y,2);
					Score.takeOneRocks();
				}
				f.current = f.trace;
				f.step();
			};

			Cell.prototype.keypress = function(key,f){
				var doMove = function(x,y){
					Score.addOneMove();
					f.x = x; f.y = y;
				}
				if(f.startAdded){
					this.universe[f.x][f.y]=1;//clear where I am
					if(key.keyCode===39){//right
						if(f.universe[f.x+1][f.y]===1)doMove(f.x+1,f.y);
					} else if (key.keyCode===40){//down
						if(f.universe[f.x][f.y+1]===1)doMove(f.x,f.y+1);
					} else if (key.keyCode===38){//up
						if(f.universe[f.x][f.y-1]===1)doMove(f.x,f.y-1);
					} else if (key.keyCode===37){//left
						if(f.universe[f.x-1][f.y]===1)doMove(f.x-1,f.y);
					} else if (key.charCode===100){
						f.dig(f.x+1,f.y);//dig right
					} else if (key.charCode===97){
						f.dig(f.x-1,f.y);//dig left
					} else if (key.charCode===119){
						f.dig(f.x,f.y-1);//dig up
					} else if (key.charCode===115){
						f.dig(f.x,f.y+1);//dig down
					} else {
						console.log(key);
					}
					if(f.y>f.h-1)f.y=f.h-1;
					else if(f.y<0)f.y=0;
					if(f.x>f.w-1)f.x=f.w-1;
					else if(f.x<0)f.x=0;
					f.drop(f.x,f.y,4);
					f.draw();
				}
			};
			
			var c = new Cell('canvas');
			
			var list = [
				{t:100,f:c.cave},
				{t:2,f:c.smooth},
				{t:2,f:c.squash},
				{t:1,f:c.trace},
				{t:1,f:c.seedWater},
				{t:1,f:c.seedGold},
				{t:10,f:c.waterFlow},
				{t:10,f:c.waterFill},
				{t:1,f:c.addStart},
			];

			var perform = function(l){
				var i = 1;
				var interval = null;
				if(l<list.length){
					c.current = list[l].f;
					interval = window.setInterval(function(){
						c.iterate(c);
						if(i>list[l].t) {
							clearInterval(interval);
							perform(l+1);
						}
						i++;
					}, 12);	
				}
			}

			document.getElementById('do').onclick=function(){
				c.initialise();
				perform(0);
			};

			window.onkeypress = function(e){c.keypress(e,c);};

		}());
	</script>
</body>
</html>