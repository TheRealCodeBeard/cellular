<!DOCTYPE html>
<html>
<head>
	<title>Map Generator</title>
	<meta charset="UTF-8">
	<style type="text/css">
		#canvas
		{
			border:solid 2px maroon;
		}
		#name
		{
			color:black;
			background-color: white;
			margin:2px;
			border:solid 1px grey;
			display:block;
			font-family: sans-serif;
			width:50%;
			margin-left:25%;
			padding:5px;
		}
		#mynamelabel
		{
			color:white;
		}
		body
		{
			background-color:black;
		}
		.holder
		{
			padding-top:10px;
			text-align:center;
		}
		.controls{
			margin-bottom: 5px;
		}
		.controls input,.controls button{
			border:solid 1px gray;
			font-family: monospace;
			vertical-align: -5px;
		}
		.controls input{
			width: 3em;
		}
		#seen,.whiteText,.info,.movement {
			color:white;
			font-family: monospace;
		}
		.whiteText {
			margin-bottom: 3px;
		}
		.movement {
			margin-bottom: 3px;
		}
		.movement span{
			display:inline-block;
			width:25px;
			cursor: pointer;
			border: solid 1px white;
		}
		.movement span:active{
			background-color: white;
			color:black;
		}
		.info span {
			display: inline-block;
			width:50px;
			border: solid 1px white;
			cursor: pointer;
			border-radius: 2px;
			margin: 0 4px;
		}
		.info span.selected{
			background-color: #555;
			-webkit-transform: rotate(5deg); 
			-moz-transform: rotate(5deg); 
			-o-transform: rotate(5deg);
			-ms-transform: rotate(5deg);
			transform:rotate(5deg);
		}
		#gold {
			color:yellow;
		}
		#moves {
			color:red;
		}
		#rocks {
			color:gray;
		}
		#leaves {
			color:green;
		}
		#wood {
			color:brown;
		}
	</style>
</head>
<body>
	<div class='holder'>
		<div class="controls"><input type="text" id="chance" value="0.92"/> <button id="do">Generate</button></div>
		<canvas id="canvas" width="400" height="400">Your browser doesn't support HTML5 Canvas.</canvas>
		<div>
			<input type="checkbox" id="myname" text="use my name"><label id="mynamelabel">use my name</label><input type="text" id="name"/></span>
		</div>
	</div>
	<script src="seedrandom.min.js"></script>
  	<script type="text/javascript"> 

  		var Colours = {
			black 		: 'rgb(0,0,0)',
			ground 		: 'rgb(245,222,179)',
			player 		: 'rgb(255,0,0)',
			leaves		: 'rgb(0,230,0)',
			grass		: 'rgb(0,150,0)',
			thickgrass	: 'rgb(0,140,0)',
			wood 		: 'rgb(160,82,45)',
			water 		: 'rgb(0,0,255)',
			deepwater	: 'rgb(0,0,200)',
			purple 		: 'rgb(255,0,255)',
			gold 		: 'rgb(240,240,0)',
			rocks 		: 'rgb(100,100,100)',
			hard 		: 'rgb(50,50,50)',
			hidden 		: 'rgb(15,10,10)',
			stone 		: 'rgb(80,80,80)',
			highstone	: 'rgb(110,110,110)',
			snow		: 'rgb(255,255,255)',
			sand 		: 'rgb(222,184,135)',//255-239-213//237, 201, 175
			castle		: 'rgb(215,192,169)',
			wall		: 'rgb(70,50,70)',
			tower		: 'rgb(40,10,40)',
			moat 		: 'rgb(0,0,255)',
			bridge 		: 'rgb(170,92,55)',
			get:function(name){
				return this[name];
			}
  		};

  		var Elements = {
  			stone:0,
  			ground:1,
  			rocks:2,
  			water:3,
  			player:4,
  			wood:5,
  			leaves:6,
  			gold:7,
  			hard:8,
  			hidden:9,
  			deepwater:10,
  			sand:11,
			grass:12,
			thickgrass:13,
			highstone:14,
			snow:15,
			castle:16,
			wall:17,
			tower:18,
			moat:19,
			bridge:20,
  			build:function(){
  				for(var el in this){
  					if(isNaN(el)){
  						this[this[el]]=el;
  					}
	  			}
  			},
  			get:function(id){
  				return this[id];
  			}
  		};
  		Elements.build();//makes a nice lookup

  	</script>
	<script>
		(function(){

			var Cell = function(canvas_id){
				var me = this;
				var canvas = document.getElementById(canvas_id);
				me.ctx = canvas.getContext('2d');
				me.universe=null;
				me.wh = 5;
				me.w=me.ctx.canvas.clientWidth/me.wh//60;
				me.h=me.ctx.canvas.clientHeight/me.wh//60;
				me.cln = null;
			};
		
			Cell.prototype.choose = function(a,b,limit){
				return (Math.random()< limit ? a : b);
			};

			Cell.prototype.generate = function(){
				var f = this;
				var v = document.getElementById('chance').value;
				f.universe = [];
				for(var i = 0; i < f.w; i++) {
					f.universe[i] = [];
					for(var j = 0; j < f.h; j++) {
						f.universe[i][j] = f.choose(0,1,v);
					}
				}
			};
			
			Cell.prototype.distanceFrom = function(x,y,ax,ay){
				var sq= function(x){return x*x;};
				if(!x && !y) return true;
				var measured = Math.sqrt(sq(ay-y)+sq(ax-x));
				return measured;
			};

			Cell.prototype.getColour = function(element){
				var el = Elements.get(element);
				return Colours.get(el);
			};

			Cell.prototype.draw = function(){
				var me = this;				
				if(me.ctx){
					//var wh=5;//width of a drawn tile
					var wh = me.wh;
					for(var i = 0; i < me.w; i++) {
						for(var j = 0; j < me.h; j++) {
							me.ctx.fillStyle = me.getColour(me.universe[j][i]);
							me.ctx.fillRect(wh*j, wh*i, wh*j+wh, wh*i+wh);
						}
					}
				}
			};

			Cell.prototype.drop = function(x,y,v){
				try{
					if(v!==this.cln[x][y]){
						this.universe[x][y]=v;
						return true;
					}
					return false;
				} catch(e) {
					console.log('exception:',e);
					console.log(x,y);
					return false;
				}
			};

			Cell.prototype.getAdjascent = function(x,y,f){
				var n,s,e,w,ne,se,nw,sw = null;
				if(y-1>=0) n = f.cln[x][y-1];
				if(y+1<f.h) s = f.cln[x][y+1];
				if(x+1<f.w) e = f.cln[x+1][y];
				if(x-1>=0) w = f.cln[x-1][y];
				
				if(x+1<f.w && y-1>=0) ne =f.cln[x+1][y-1];
				if(x+1<f.w && y+1<f.h) se =f.cln[x+1][y+1];
				if(x-1>=0 && y-1>=0) nw =f.cln[x-1][y-1];
				if(x-1>=0 && y+1<f.h) sw =f.cln[x-1][y+1];	

				return {
					n: n,
					s: s,
					e: e,
					w: w,
					ne:ne,
					se:se,
					nw:nw,
					sw:sw,
					nsewAll:function(element){
						return 	n === element &&
								s === element &&
								e === element &&
								w === element; 
					},
					nesenwswAll:function(element){
						return 	ne === element &&
								se === element &&
								nw === element &&
								sw === element; 
					},
					areAll:function(element){
						return this.nsewAll(element) && this.nesenwswAll(element);
					},
					nsewAny:function(element){
						return 	n===element ||
								s===element ||
								e===element ||
								w===element;
					},
					nesenwswAny:function(element){
						return 	nw===element ||
								sw===element ||
								ne===element ||
								se===element;
					},
					areAny:function(element){
						return this.nsewAny(element) || this.nesenwswAny(element);
					},
					containedEast:function(element){
						return  n ===element &&
								ne===element &&
								e ===element &&
								se===element &&
								s ===element;
					},
					containedWest:function(element){
						return  n ===element &&
								nw===element &&
								w ===element &&
								sw===element &&
								s ===element;
					},
					containedNorth:function(element){
						return  w ===element &&
								nw===element &&
								n ===element &&
								ne ===element &&
								e ===element;
					},
					containedSouth:function(element){
						return  w ===element &&
								sw===element &&
								s ===element &&
								se ===element &&
								e ===element;
					},
					partialContainedEast:function(element){
						return  n ===element &&
								e ===element &&
								s ===element;
					},
					partialContainedWest:function(element){
						return  n ===element &&
								w ===element &&
								s ===element;
					},
					partialContainedNorth:function(element){
						return  w ===element &&
								n ===element &&
								e ===element;
					},
					partialContainedSouth:function(element){
						return  w ===element &&
								s ===element &&
								e ===element;
					},
					partialContained:function(element){
						return  this.partialContainedEast(element)  ||
								this.partialContainedWest(element)  ||
								this.partialContainedNorth(element) ||
								this.partialContainedSouth(element);
					},
					anyNsewNotNull:function(){
						return 	n || s || e || w ;
					},
					anyNsewNull:function(){
						return n===null || s===null || e===null || w===null;
					}
				};
			};

//processes

			Cell.prototype.cave = function(val,x,y){
				var f = this;
				var adj = f.getAdjascent(x,y,f);
				if(val){
					if(adj.nsewAll(Elements.stone)){f.drop(x,y,Elements.stone);}
				} else {
					if(adj.anyNsewNotNull(Elements.stone)){
						f.drop(x,y,f.choose(Elements.stone,Elements.ground,0.97));
					}
				}
			};

			Cell.prototype.smooth = function(val,x,y){
				var f = this;
				var adj = f.getAdjascent(x,y,f);
				if(val === Elements.ground){
					if(adj.containedEast(Elements.stone)){f.drop(x,y,Elements.stone);}
					if(adj.containedWest(Elements.stone)){f.drop(x,y,Elements.stone);}
					if(adj.containedNorth(Elements.stone)){f.drop(x,y,Elements.stone);}
					if(adj.containedSouth(Elements.stone)){f.drop(x,y,Elements.stone);}
				} else if (val === Elements.stone) {
					if(adj.containedEast(Elements.ground)){f.drop(x,y,Elements.ground);}
					if(adj.containedWest(Elements.ground)){f.drop(x,y,Elements.ground);}
					if(adj.containedNorth(Elements.ground)){f.drop(x,y,Elements.ground);}
					if(adj.containedSouth(Elements.ground)){f.drop(x,y,Elements.ground);}
				}
			};

			Cell.prototype.squash = function(val,x,y){
				var f = this;
				var adj = f.getAdjascent(x,y,f);
				if(val===Elements.ground){
					if(adj.nsewAll(Elements.stone)){f.drop(x,y,Elements.stone);}
				} else if (val === Elements.stone) {
					if(adj.nsewAll(Elements.ground)){f.drop(x,y,Elements.ground);}
				}
				if(adj.anyNsewNull()){f.drop(x,y,Elements.stone);}
			};

			Cell.prototype.trace = function(val,x,y){
				var f = this;
				var adj = f.getAdjascent(x,y,f);
				if(val){
					if(adj.n!==Elements.stone&&!adj.n)f.drop(x,y,Elements.hard);
					if(adj.s!==Elements.stone&&!adj.s)f.drop(x,y,Elements.hard);
					if(adj.e!==Elements.stone&&!adj.e)f.drop(x,y,Elements.hard);
					if(adj.w!==Elements.stone&&!adj.w)f.drop(x,y,Elements.hard);
					if(val!==Elements.gold){
						if(adj.nsewAll(Elements.rocks)||adj.nsewAll(Elements.stone))f.drop(x,y,Elements.stone);
					}
				} else {
					if(val!==Elements.gold){
						if(adj.nsewAny(Elements.ground))f.drop(x,y,Elements.rocks);
					}
				}
			};

			Cell.prototype.higherMountain = function(val,x,y){
				var f = this;
				if(val === Elements.stone){
					var adj = f.getAdjascent(x,y,f);
					if(adj.areAll(Elements.stone))f.drop(x,y,f.choose(val,Elements.highstone,0.6));
				}
			};

			Cell.prototype.highFill = function(val,x,y){
				var f = this;
				if(val === Elements.stone){
					var adj = f.getAdjascent(x,y,f);
					if(adj.areAll(Elements.highstone))f.drop(x,y,Elements.highstone);
					if(adj.nsewAll(Elements.highstone))f.drop(x,y,Elements.highstone);
					if(adj.containedNorth(Elements.highstone))f.drop(x,y,Elements.highstone);
					if(adj.containedSouth(Elements.highstone))f.drop(x,y,Elements.highstone);
					if(adj.containedEast(Elements.highstone))f.drop(x,y,Elements.highstone);
					if(adj.containedWest(Elements.highstone))f.drop(x,y,Elements.highstone);
					if(adj.partialContained(Elements.highstone))f.drop(x,y,Elements.highstone);
				}
			};

			Cell.prototype.highSquash = function(val,x,y){
				var f = this;
				if(val === Elements.highstone){
					var adj = f.getAdjascent(x,y,f);
					if(adj.areAll(Elements.stone))f.drop(x,y,Elements.stone);
				}
			}

			Cell.prototype.snowCap = function(val,x,y){
				var f = this;
				if(val===Elements.highstone || val === Elements.snow){
					var adj = f.getAdjascent(x,y,f);
					if(	adj.nsewAll(Elements.highstone)){
						f.drop(x,y,f.choose(val,Elements.snow,0.7));
					} else if (adj.nsewAll(Elements.snow) || adj.partialContained(Elements.snow)){
						f.drop(x,y,Elements.snow);
					}
				}
			};

			Cell.prototype.seedWater = function(val,x,y){
				if(val===Elements.ground){
					this.drop(x,y,this.choose(val,Elements.water,0.997));
				}
			};

			Cell.prototype.waterFlow = function(val,x,y){
				var f = this;
				if(val===Elements.ground){
					var adj = f.getAdjascent(x,y,f);
					if(adj.nsewAny(Elements.water))f.drop(x,y,f.choose(val,3,0.8));
				}
			};

			Cell.prototype.waterFill = function(val,x,y){
				var f = this;
				var adj = f.getAdjascent(x,y,f);
				if(adj.partialContained(Elements.water))f.drop(x,y,Elements.water);
			};

			Cell.prototype.waterDeepen = function(val,x,y){
				var f = this;
				if(val===Elements.water || val === Elements.deepwater)
				{
					var adj = f.getAdjascent(x,y,f);
					if(adj.areAll(Elements.water)||adj.areAll(Elements.deepwater)) f.drop(x,y,Elements.deepwater);
				}
			};

			Cell.prototype.addSand = function(val,x,y){
				//This is a special case where it's in a corner.
				//So not generalising in ADJ function
				var f = this;
				var allAcceptable = function(v1,v2,v3){
					var allSand = function(a,b,c){
						return a===Elements.sand && b===Elements.sand && c ===Elements.sand;
					};	
					var isAcceptable = function(v){
						return v===Elements.water || v===Elements.sand;
					};
					return isAcceptable(v1) && isAcceptable(v2) && isAcceptable(v3) && !allSand(v1,v2,v3);
				};
				if(val===Elements.ground){
					var adj = f.getAdjascent(x,y,f);
					if(	   
						allAcceptable(adj.n,adj.ne,adj.e)
						|| allAcceptable(adj.n,adj.nw,adj.w)
						|| allAcceptable(adj.s,adj.se,adj.e)
						|| allAcceptable(adj.s,adj.sw,adj.w)
						)f.drop(x,y,Elements.sand);
				}
				
			};

			Cell.prototype.seedTrees = function(val,x,y){
				if(val===Elements.ground)this.drop(x,y,this.choose(val,Elements.wood,0.99));
			};

			Cell.prototype.treeGrow = function(val,x,y){
				var f = this;
				if(val===Elements.ground){
					var adj = f.getAdjascent(x,y,f);
					if(adj.nsewAny(Elements.wood))f.drop(x,y,Elements.leaves);
				}
			};

			Cell.prototype.seedGrass = function(val,x,y){
				var f = this;
				if(val===Elements.ground){
					var adj = f.getAdjascent(x,y,f);
					if(!adj.areAny(Elements.leaves) && !adj.areAny(Elements.rocks))
					{
						var prob = 0.997
						if(adj.areAny(Elements.sand))prob=0.8;
						this.drop(x,y,this.choose(val,Elements.grass,prob));
					}
				}
			};

			Cell.prototype.growGrass = function(val,x,y){
				var f = this;
				if(val===Elements.ground){
					var adj = f.getAdjascent(x,y,f);
					if(adj.nsewAny(Elements.grass))
					{
						if(	!adj.areAny(Elements.leaves) && 
							!adj.areAny(Elements.wood) && 
							!adj.areAny(Elements.rocks))
						{
							f.drop(x,y,f.choose(val,Elements.grass,0.7));
						}
					}
				}
			};

			Cell.prototype.grassThicken = function(val,x,y){
				var f = this;
				if(val === Elements.grass || val === Elements.thickgrass)
				{
					var adj = f.getAdjascent(x,y,f);
					if(adj.areAll(Elements.grass)||adj.areAll(Elements.thickgrass))
					{
						f.drop(x,y,f.choose(val,Elements.thickgrass,0.7));
					} else if (adj.areAny(Elements.water))
					{
						f.drop(x,y,f.choose(val,Elements.thickgrass,0.5));
					}
				}
			};

			Cell.prototype.placeCastle = function(val,x,y){
				var f = this;
				var adj = f.getAdjascent(x,y,f);
				if(x>5 && x<(f.w * f.wh)-5 && y > 5 && y< (f.h * f.wh) -5)
				{
					var isCastleGround = function(val){
						return val === Elements.ground || val === Elements.thickgrass || val === Elements.grass;
					};
					if(adj.areAll(Elements.ground)||adj.areAll(Elements.thickgrass)||adj.areAll(Elements.grass))
					{
						var build = function(){
							f.drop(x,y,Elements.castle);
							f.drop(x+1,y,Elements.wall);
							f.drop(x-1,y,Elements.wall);
							f.drop(x,y+1,Elements.wall);
							f.drop(x,y-1,Elements.wall);
							f.drop(x+1,y+1,Elements.tower);
							f.drop(x-1,y-1,Elements.tower);
							f.drop(x-1,y+1,Elements.tower);
							f.drop(x+1,y-1,Elements.tower);

							f.drop(x+2,y,Elements.moat);
							f.drop(x-2,y,Elements.moat);
							f.drop(x,y+2,Elements.bridge);
							f.drop(x,y+3,Elements.bridge);
							f.drop(x,y-2,Elements.moat);
							f.drop(x+2,y+2,Elements.moat);
							f.drop(x-2,y-2,Elements.moat);
							f.drop(x-2,y+2,Elements.moat);
							f.drop(x+2,y-2,Elements.moat);

							f.drop(x+2,y+1,Elements.moat);
							f.drop(x+2,y-1,Elements.moat);
							f.drop(x-2,y+1,Elements.moat);
							f.drop(x-2,y-1,Elements.moat);
							f.drop(x+1,y+2,Elements.moat);
							f.drop(x-1,y+2,Elements.moat);
							f.drop(x+1,y-2,Elements.moat);
							f.drop(x-1,y-2,Elements.moat);
						};
						var dontBuild = function(){
							f.drop(x,y,val);
						};
						var chosen = f.choose(dontBuild,build,0.999);
						chosen();
					} 
				}
			};

//end processes

			Cell.prototype.process = function(val,x,y){
				this.current(val,x,y);
			};
			
			Cell.prototype.clone = function(){
				var me = this;
				var cln = [];
				var i,l = null;
    			for(i = 0; i< me.w; i++) {
					cln[i] = me.universe[i].slice(0);
				}
				return cln;
			};

			Cell.prototype.step = function(){
				var f = this;
				var x,y,val = null;
				f.cln = f.clone();
				for(x = 0; x < f.w; x++) {
					for(y = 0; y < f.h; y++) {
						val = f.cln[x][y];
						f.process(val,x,y);
					}
				}
			};
			
			Cell.prototype.initialise = function(){
				var me = this;
				me.x=null;
				me.y=null;
				me.generate();
				me.draw();
			};
			
			Cell.prototype.iterate = function(f){
				f.step();
				f.draw();
			};

			var c = new Cell('canvas');
			
			var list = [
				{t:100,f:c.cave},
				{t:3,f:c.smooth},
				{t:2,f:c.squash},
				{t:1,f:c.trace},
				{t:1,f:c.higherMountain},
				{t:1,f:c.highFill},
				{t:1,f:c.highSquash},
				{t:3,f:c.snowCap},
				{t:1,f:c.seedWater},
				{t:10,f:c.waterFlow},
				{t:10,f:c.waterFill},
				{t:1,f:c.waterDeepen},
				{t:2,f:c.addSand},
				{t:1,f:c.seedTrees},
				{t:1,f:c.treeGrow},
				{t:1,f:c.seedGrass},
				{t:30,f:c.growGrass},
				{t:1,f:c.grassThicken},
				{t:1,f:c.placeCastle}
			];

			var name = function(){
				var starts = ["Vos","Cal","Bra","La", "Le", "Ben-", "Fra","Min","El","Porto-","High-", "Co", "Chri", "Saint-"];
				var mids = ["cos","bra","ma","ka","bro","ich","lo","cole","si","se","fro","klo","gra","pre","spo", "pun", "krel","kun","bo","hehe", "hoho", ""];
				var ends = ["nova","land","noc"," landing","sia","po","mra","tak"," water"," machi", "grad", "scotia", "helm","man", " Sword", "-yama"];
				var pick_start = Math.round(Math.random()*(starts.length-1));
				var pick_mid = Math.round(Math.random()*(mids.length-1));
				var pick_end = Math.round(Math.random()*(ends.length-1));
				var landname = "" + starts[pick_start] + mids[pick_mid] + ends[pick_end];
				document.getElementById('name').value=landname;
			};

			var clearName = function(){
				document.getElementById('name').value="...building"
			};

			var perform = function(l){
				var i = 1;
				var interval = null;
				if(l<list.length){
					c.current = list[l].f;
					interval = window.setInterval(function(){
						c.iterate(c);
						if(i>list[l].t) {
							clearInterval(interval);
							perform(l+1);
						}
						i++;
					}, 12);	
				} /*else {
					name();
				}*/
			};

			document.getElementById('do').onclick=function(){
				if(!document.getElementById('myname').checked){
					clearName();
					name();
				};
				Math.seedrandom(document.getElementById('name').value);
				c.initialise();
				perform(0);
			};

		}());
	</script>
</body>
</html>